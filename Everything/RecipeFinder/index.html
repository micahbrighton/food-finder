<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.5/css/bulma.min.css" />
    <link rel="import" href="../autocompleteIngredients/index.html">
    <link rel="import" href="../autocompleteAllergies/index.html">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <!-- <link rel="import" href="ModalRecipeBox/index.html"> -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * {
            box-sizing: border-box;
        }

        .center {
            display: block;
            margin-left: auto;
            margin-right: auto;
            width: 50%;
        }

        body {
            font: 16px Arial;
        }

        /*the container must be positioned relative:*/
        .autocomplete {
            position: relative;
            display: inline-block;
        }

        input {
            border: 1px solid transparent;
            background-color: #f1f1f1;
            padding: 10px;
            font-size: 16px;
        }

        input[type=text] {
            background-color: #f1f1f1;
            width: 100%;
        }

        input[type=submit] {
            background-color: DodgerBlue;
            color: #fff;
            cursor: pointer;
        }

        .autocomplete-items {
            position: absolute;
            border: 1px solid #d4d4d4;
            border-bottom: none;
            border-top: none;
            z-index: 99;
            /*position the autocomplete items to be the same width as the container:*/
            top: 100%;
            left: 0;
            right: 0;
        }

        .autocomplete-items div {
            padding: 10px;
            cursor: pointer;
            background-color: #fff;
            border-bottom: 1px solid #d4d4d4;
        }

        /*when hovering an item:*/
        .autocomplete-items div:hover {
            background-color: #e9e9e9;
        }

        /*when navigating through the items using the arrow keys:*/
        .autocomplete-active {
            background-color: DodgerBlue !important;
            color: #ffffff;
        }

        #feedbox {
            width: 80%;
            padding: 10px;
            text-align: center;
            margin: auto;
            overflow-y: scroll;

        }

        .modal-content {
            background-color: #99c3df;
            margin: auto;
            border: 1px solid #888;
            width: 800px;
        }

        /* star ratings */

        .starChecked {
            color: orange;
        }


        .starRating {
            border: none;
            float: left;
        }

        .starRating>input {
            display: none;
        }

        .starRating>label:before {
            margin: 5px;
            font-size: 1.25em;
            font-family: FontAwesome;
            display: inline-block;
            content: "\f005";
        }

        .starRating>.half:before {
            content: "\f089";
            position: absolute;
        }

        .starRating>label {
            color: #ddd;
            float: right;
        }

        /***** CSS Magic to Highlight Stars on Hover *****/

        .starRating>input:checked~label,
        /* show gold star when clicked */
        .starRating:not(:checked)>label:hover,
        /* hover current star */
        .starRating:not(:checked)>label:hover~label {
            color: #FFD700;
        }

        /* hover previous stars in list */

        .starRating>input:checked+label:hover,
        /* hover current star when changing rating */
        .starRating>input:checked~label:hover,
        .starRating>label:hover~input:checked~label,
        /* lighten current selection */
        .starRating>input:checked~label:hover~label {
            color: #FFED85;
        }

        .hero-body {
            background-color: rgb(238, 238, 238);
        }

        /* Style the button that is used to open and close the collapsible content */
        .collapsible {
            background-color: #fff;
            color: #444;
            cursor: pointer;
            padding: 18px;
            width: 100%;
            border: none;
            text-align: left;
            outline: none;
            font-size: 15px;
        }

        /* Add a background color to the button if it is clicked on (add the .active class with JS), and when you move the mouse over it (hover) */
        .active,
        .collapsible:hover {
            background-color: #ccc;
        }

        /* Style the collapsible content. Note: hidden by default */
        .content {
            padding: 0 18px;
            background-color: white;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.2s ease-out;
        }

        .collapsible:after {
            content: '\02795';
            /* Unicode character for "plus" sign (+) */
            font-size: 13px;
            color: #eee;
            float: right;
            margin-left: 5px;
        }

        .active:after {
            content: "\2796";
            /* Unicode character for "minus" sign (-) */
        }
    </style>
    <script>
        $(function () {
            $("#autocomplete").load("../autocompleteIngredients/index.html");
            $("#autocomplete2").load("../autocompleteAllergies/index.html");
        });
    </script>
</head>



<body>
    <section class="hero is-fullheight is-default is-bold">
        <div class="hero-head">
            <nav class="navbar">
                <div class="container">
                    <div class="navbar-brand">
                        <a class="navbar-item" href="/index.html">
                            <img src="/logo_black.png" style="padding-right: 5px;"><b> Food Finder</b>
                        </a>
                        <span class="navbar-burger burger" data-target="navbarMenu">
                            <span></span>
                            <span></span>
                            <span></span>
                        </span>
                    </div>
                    <div id="navbarMenu" class="navbar-menu">
                        <div class="navbar-end">
                            <div class="tabs is-right">
                                <ul>
                                    <li class="is-active"><a href="/RecipeFinder/index.html">Recipe Finder</a></li>
                                    <li><a href="/code/profile/index.html">Profile</a></li>
                                    <li><a id="logout">Log Out</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </nav>
        </div>
        <div class="hero-body" style="display: inline;">
            <div class="columns">
                <div class="column is-one-third">
                    <div id="ingredientInputDiv">

                        <br>
                        <label class="label" style="text-align: center; font-size:1.25rem">What ingredients do you
                            have?</label>
                        <div id="autocomplete"></div>


                        <!--Make sure the form has the autocomplete function switched off:-->

                    </div>
                    <br>
                    <button type="button" class="collapsible"
                        style="text-align: center; font-size:20px;font-weight:bold"><b>Diets</b></button>
                    <div class="content" id="dietInputDiv">
                        <div class="field">

                            <div class="control" style="width:100%; float: none; text-align: center; margin:auto">
                                <div class="columns">
                                    <div class="column" style="margin-left:2%; padding-bottom:5%">
                                        <div style="display:flex;
                                        flex-direction:column;
                                        text-align: left;">
                                            <label class="is-checkradio is-info">
                                                <input type="checkbox" id="gluten">
                                                Gluten Free
                                            </label>
                                        </div>
                                        <div style="display:flex;
                                        flex-direction:column;
                                        text-align: left">
                                            <label class="checkbox">
                                                <input type="checkbox" id="vegetarian">
                                                Vegetarian
                                            </label>
                                        </div>
                                        <div style="display:flex;
                                        flex-direction:column;
                                        text-align: left">
                                            <label class="checkbox">
                                                <input type="checkbox" id="vegan">
                                                Vegan
                                            </label>
                                        </div>
                                        <div style="display:flex;
                                        flex-direction:column;
                                        text-align: left">
                                            <label class="checkbox">
                                                <input type="checkbox" id="lacto-vegetarian">
                                                Lacto-Vegetarian
                                            </label>
                                        </div>
                                        <div style="display:flex;
                                        flex-direction:column;
                                        text-align: left">
                                            <label class="checkbox">
                                                <input type="checkbox" id="ovo-vegetarian">
                                                Ovo-Vegetarian
                                            </label>
                                        </div>
                                    </div>
                                    <div class="column" style="margin-left:2%;">
                                        <div style="display:flex;
                                        flex-direction:column;
                                        text-align: left">
                                            <label class="checkbox">
                                                <input type="checkbox" id="ketogenic">
                                                Ketogenic
                                            </label>
                                        </div>
                                        <div style="display:flex;
                                        flex-direction:column;
                                        text-align: left">
                                            <label class="checkbox">
                                                <input type="checkbox" id="pescetarian">
                                                Pescetarian
                                            </label>
                                        </div>
                                        <div style="display:flex;
                                        flex-direction:column;
                                        text-align: left">
                                            <label class="checkbox">
                                                <input type="checkbox" id="paleo">
                                                Paleo
                                            </label>
                                        </div>
                                        <div style="display:flex;
                                        flex-direction:column;
                                        text-align: left">
                                            <label class="checkbox">
                                                <input type="checkbox" id="primal">
                                                Primal
                                            </label>
                                        </div>
                                        <div style="display:flex;
                                        flex-direction:column;
                                        text-align: left">
                                            <label class="checkbox">
                                                <input type="checkbox" id="whole30">
                                                Whole30
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="collapsible"
                        style="text-align: center;font-size:20px;font-weight:bold"><b>Intolerances</b></button>
                    <div class="content" id="intoleranceInputDiv">
                        <div class="field">

                            <div class="control" style="width:100%; float: none; text-align: center; margin: auto">
                                <div class="columns">
                                    <div class="column" style="margin-left:2%;padding-bottom:5%">
                                        <div style="display:flex;
                                        flex-direction:column;
                                        text-align: left">
                                            <label class="checkbox">
                                                <input type="checkbox" id="dairy">
                                                Dairy
                                            </label>
                                        </div>
                                        <div style="display:flex;
                                    flex-direction:column;
                                    text-align: left">
                                            <label class="checkbox">
                                                <input type="checkbox" id="egg">
                                                Egg
                                            </label>
                                        </div>
                                        <div style="display:flex;
                                    flex-direction:column;
                                    text-align: left">
                                            <label class="checkbox">
                                                <input type="checkbox" id="gluten2">
                                                Gluten
                                            </label>
                                        </div>
                                        <div style="display:flex;
                                    flex-direction:column;
                                    text-align: left">
                                            <label class="checkbox">
                                                <input type="checkbox" id="grain">
                                                Grain
                                            </label>
                                        </div>
                                        <div style="display:flex;
                                    flex-direction:column;
                                    text-align: left">
                                            <label class="checkbox">
                                                <input type="checkbox" id="peanut">
                                                Peanut
                                            </label>
                                        </div>
                                        <div style="display:flex;
                                    flex-direction:column;
                                    text-align: left">
                                            <label class="checkbox">
                                                <input type="checkbox" id="seafood">
                                                Seafood
                                            </label>
                                        </div>
                                    </div>
                                    <div class="column" style="margin-left: 2%">
                                        <div style="display:flex;
                                    flex-direction:column;
                                    text-align: left">
                                            <label class="checkbox">
                                                <input type="checkbox" id="sesame">
                                                Sesame
                                            </label>
                                        </div>
                                        <div style="display:flex;
                                    flex-direction:column;
                                    text-align: left">
                                            <label class="checkbox">
                                                <input type="checkbox" id="shellfish">
                                                Shellfish
                                            </label>
                                        </div>
                                        <div style="display:flex;
                                    flex-direction:column;
                                    text-align: left">
                                            <label class="checkbox">
                                                <input type="checkbox" id="soy">
                                                Soy
                                            </label>
                                        </div>
                                        <div style="display:flex;
                                    flex-direction:column;
                                    text-align: left">
                                            <label class="checkbox">
                                                <input type="checkbox" id="sulfite">
                                                Sulfite
                                            </label>
                                        </div>
                                        <div style="display:flex;
                                    flex-direction:column;
                                    text-align: left">
                                            <label class="checkbox">
                                                <input type="checkbox" id="tree-nut">
                                                Tree Nut
                                            </label>
                                        </div>
                                        <div style="display:flex;
                                    flex-direction:column;
                                    text-align: left">
                                            <label class="checkbox">
                                                <input type="checkbox" id="wheat">
                                                Wheat
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="allergyEntry">
                        <label class="label" style="text-align: center; font-size:1.25rem">What are you allergic
                            to?</label>
                        <div id="autocomplete2"></div>
                        <div id="list2">


                        </div>
                    </div>
                    <button type="button" id="getRecipes" class="button is-outlined is-large is-rounded is-fullwidth"
                        style="background-color: #4B9CD3; color: #FFF">
                        <span class="icon">
                            <i class="fa fa-search"></i>
                        </span>
                        <span>Find Recipes</span>
                    </button>
                </div>
                <div class="column">
                    <h2 style="font-weight:bold; text-align:center;font-size:1.5rem;">Recipe Recommendations</h2>
                    <div>
                        <a class="level-item">
                            <div id="feedbox">


                            </div>
                        </a>
                    </div>

                    <div id="myModal" class="modal">

                        <!-- Modal content -->
                        <div class="modal-content" id=myModalContent>
                            <span class="close">&times;</span>
                            <nav class="level-right">
                                <div class="level-right">
                                    <div class="level-item">

                                        <fieldset class="starRating">
                                            <input type="radio" id="saveRecipe" name="starRating" value="0" /><label
                                                class="full" for="saveRecipe" title="Save the Recipe"></label>
                                        </fieldset>
                                    </div>
                                </div>

                            </nav>

                            <h1 id="title"> </h1>
                            <div id="pic">

                            </div>
                            <div id="ratings">

                            </div>
                            <div id="ingredientsNeeded">

                            </div>
                            <div id="dietsSupported">

                            </div>

                            <div id="instructions">

                            </div>
                            <div id="postedReviews" class="posts">

                            </div>

                            <div id="reviewBox" class="box">

                                <article class="media">
                                    <figure class="media-left">
                                        <p class="image is-64x64">
                                            <img src="https://bulma.io/images/placeholders/128x128.png">
                                        </p>
                                    </figure>
                                    <div class="media-content">
                                        <fieldset class="starRating">
                                            <input type="radio" id="star5" name="starRating" value="5" /><label
                                                class="full" for="star5" title="Awesome - 5 stars"></label>

                                            <input type="radio" id="star4" name="starRating" value="4" /><label
                                                class="full" for="star4" title="Pretty good - 4 stars"></label>

                                            <input type="radio" id="star3" name="starRating" value="3" /><label
                                                class="full" for="star3" title="Meh - 3 stars"></label>

                                            <input type="radio" id="star2" name="starRating" value="2" /><label
                                                class="full" for="star2" title="Kinda bad - 2 stars"></label>

                                            <input type="radio" id="star1" name="starRating" value="1" /><label
                                                class="full" for="star1" title="Sucks big time - 1 star"></label>

                                        </fieldset>
                                        <div class="field">
                                            <p class="control">
                                                <textarea class="textarea" id="reviewText"
                                                    placeholder="Add a comment..."></textarea>
                                            </p>
                                        </div>
                                        <div class="field">
                                            <p class="control">
                                                <button class="button is-info" id="postReview"
                                                    type="button">Submit</button>
                                            </p>
                                        </div>

                                    </div>
                                </article>
                            </div>

                        </div>

                    </div>

                    <div id="myModalPrivateExists" class="modal">




                    </div>
                    <div id="myModalPublic" class="modal">

                        <!-- Modal content -->
                        <div class="modal-content" id=myModalPublicContent>
                            <span class="close">&times;</span>
                            <nav class="level-right">
                                <div class="level-right">
                                    <div class="level-item">


                                    </div>
                                </div>

                            </nav>

                            <h1 id="titlePublic" style=text-align:center class="title"> </h1>
                            <div id="picPublic" class="center">

                            </div>
                            <div id="ratingsPublic">

                            </div>

                            <div id="ingredientsNeededPublic" class="container">

                            </div>
                            <div id="dietsSupportedPublic">

                            </div>

                            <div id="instructionsPublic">

                            </div>
                            <div id="postedReviewsPublic">
                                <strong>Log in to view comments and ratings and save recipes</strong>
                            </div>


                        </div>
                    </div>


                </div>
            </div>

            <script src="../node_modules/axios/dist/axios.js"></script>
            <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
            <script>
                const API_KEY = "128541af6bef438a808dc04669c8f556";
                var returnIngreds = [];
                var enteredIngreds = [];
                var enteredAllergies = []
                var user = '';
                var recipesResponse;
                if (sessionStorage.getItem('jwt') === null) {
                    console.log('nobody is signed in')
                    enteredAllergies = []
                }
                else {
                    axios.get('http://localhost:3000/user/data',
                        {

                            headers: { Authorization: "Bearer " + sessionStorage.getItem('jwt') }

                        }).then((response) => {
                            console.log(response);
                            for (let i = 0; i < response.data.result.diets.length; i++) {

                                let diet = response.data.result.diets[i];
                                document.getElementById(diet).checked = true;

                            }
                            for (let i = 0; i < response.data.result.intolerances.length; i++) {
                                let intolerance = response.data.result.intolerances[i];
                                document.getElementById(intolerance).checked = true;

                            }
                            for (let i = 0; i < response.data.result.allergies.length; i++) {
                                enteredAllergies.push(response.data.result.allergies[i]);

                                var node = document.createElement("LI");
                                var textnode = document.createTextNode(response.data.result.allergies[i]);
                                console.log(textnode.nodeValue)       // Create a text node
                                node.appendChild(textnode);                              // Append the text to <li>
                                var deleteIcon = document.createElement('span')
                                deleteIcon.innerHTML = ('<span class="delete" id="icon-minus">X</span>');
                                node.appendChild(deleteIcon);


                                console.log(document.getElementById("list2"))
                                document.getElementById("list2").appendChild(node);     // Append <li> to <ul> with id="myList"


                                console.log(enteredAllergies)

                                $('.delete').on('click', function () {

                                    console.log($(this).parent().parent()[0].childNodes[0].data);
                                    let removedIngredient = $(this).parent().parent()[0].childNodes[0].data;

                                    for (var i = 0; i < enteredAllergies.length; i++) {
                                        if (enteredAllergies[i] === removedIngredient) {
                                            enteredAllergies.splice(i, 1);
                                        }
                                    }

                                    $(this).parent().parent().remove();

                                });

                            }
                        }).catch((error) => {
                            console.log(error)
                        });

                    // axios.get('http://localhost:3000/account/status',
                    // {

                    //     headers: { Authorization: "Bearer " + sessionStorage.getItem('jwt') }

                    // }).then((response) => {
                    //     console.log(response);
                    //     user = response.data.user.name;
                    // }).catch((error) => {
                    //     console.log(error)
                    // });

                }


                $(document).on("click", "#getRecipes", function (event) {
                    var allergiesToAppend = []
                    var ul = document.getElementById("list2")
                    var items = ul.getElementsByTagName("li");
                    for (var i = 0; i < items.length; ++i) {
                        allergiesToAppend.push(items[i].innerHTML.split('<')[0]);
                    }


                    const dietsList = ["gluten", "vegetarian", "vegan", "lacto-vegetarian", "ovo-vegetarian", "ketogenic", "pescetarian", "paleo", "primal", "whole30"];
                    const intolerancesList = ["dairy", "egg", "gluten2", "grain", "peanut", "seafood", "sesame", "shellfish", "soy", "sulfite", "tree-nut", "wheat"];

                    var userIngreds = [];

                    function checked(id) {
                        return document.getElementById(id).checked;
                    }

                    console.log(allergiesToAppend)

                    let userDiets = [];
                    let userIntolerances = [];
                    dietsList.forEach(function (element) {
                        if (checked(element)) { userDiets.push(element) }
                    });
                    intolerancesList.forEach(function (element) {
                        if (checked(element)) { userIntolerances.push(element) }
                    });
                    var allergiesToAppend = []
                    var ul = document.getElementById("list2")
                    var items = ul.getElementsByTagName("li");
                    for (var i = 0; i < items.length; ++i) {
                        allergiesToAppend.push(items[i].innerHTML.split('<')[0]);
                    }


                    const ingredientsString = enteredIngreds.map(ingredient =>
                        ingredient + '%2C'
                    );

                    const dietsString = userDiets.map(ingredient =>
                        ingredient + '%2C'
                    );
                    const intolerancesString = userIntolerances.map(ingredient =>
                        ingredient + '%2C'
                    );
                    const allergiesString = allergiesToAppend.map(ingredient =>
                        ingredient + '%2C'
                    );
                    let requestString = "https://api.spoonacular.com/recipes/complexSearch?query=" + ingredientsString + "&diet=" + dietsString + "&intolerances=" + intolerancesString + "&excludeIngredients=" + allergiesString + "&instructionsRequired=true&ignorePantry=true&addRecipeInformation=true&fillIngredients=true&apiKey=128541af6bef438a808dc04669c8f556";
                    console.log(requestString)
                    $.ajax({

                        url: requestString,

                        type: 'GET',

                        headers: {

                            'Content-Type':
                                'application/json',


                        },


                    }).then((response) => {
                        if (response.totalResults === 0) {
                            alert("The ingredients you entered returned no results. Make sure you use the autocompleted options")
                            location.reload()
                        }
                        console.log(response);
                        recipesResponse = jQuery.parseJSON(JSON.stringify(response));
                        // recipesResponse = JSON.parse(recipesResponse);
                        if (document.getElementById('returnedRecipe') != null) {
                            for (var i = 0; i < 10; i++) {
                                var element = document.getElementById('returnedRecipe');
                                element.parentNode.removeChild(element);
                            }
                        }

                        for (var i = 0; i < response.results.length; i++) {
                            var img = new Image();
                            img.src = response.results[i].image;
                            var title = response.results[i].title;
                            var meal = document.createElement("DIV");
                            meal.append(img);
                            meal.append(title);
                            meal.id = "returnedRecipe"
                            document.getElementById('feedbox').append(meal);

                        }

                        //  response.results.forEach(element => document.getElementById('feedbox').append(element.src = element.image));

                        return false;

                    }).catch((error) => {
                        console.log(error);


                    });
                    $(document).on("click", "#returnedRecipe", async function (event) {
                        // clearModal();
                        let recipeId = '';
                        let clickedRecipeName = $(this)[0].lastChild.data;
                        console.log(clickedRecipeName);
                        // window.location.assign("ModalRecipeBox/index.html");


                        // document.getElementById("title").append(clickedRecipeName)
                        document.getElementById("title").innerHTML = clickedRecipeName;
                        document.getElementById("titlePublic").innerHTML = clickedRecipeName;

                        // Get the button that opens the modal
                        // var btn = document.getElementById("myBtn");

                        // Get the <span> element that closes the modal
                        var span = document.getElementsByClassName("close")[0];

                        // When the user clicks the button, open the modal 
                        //    btn.onclick = function () {

                        async function modalType() {
                            for (let i = 0; i < recipesResponse.results.length; i++) {

                                if (recipesResponse.results[i].title === clickedRecipeName) {
                                    recipeId = recipesResponse.results[i].id;
                                    console.log(recipeId);
                                    let pmeCheck = await privateModalExistsCheck(recipeId);
                                    console.log(pmeCheck);
                                    // let promisedValue = pmeCheck.then(function (result) { return result });
                                    // console.log(promisedValue);
                                    if (pmeCheck === true) {
                                        alert("its private")
                                        appendExistingPrivateModal(recipeId);
                                        // modal = document.getElementById("myModalPrivateExists")
                                        return "privateExists";
                                    }
                                    console.log("yes it worked")
                                    console.log(recipesResponse.results[i].analyzedInstructions[0].steps);
                                    //append image
                                    let img = new Image();
                                    img.src = recipesResponse.results[i].image;
                                    let title = recipesResponse.results[i].title;
                                    let meal = document.createElement("DIV");
                                    meal.append(img);
                                    meal.id = "returnedRecipeModal"
                                    document.getElementById('pic').append(meal);

                                    let imgPub = new Image();
                                    imgPub.src = recipesResponse.results[i].image;
                                    let titlePub = recipesResponse.results[i].title;
                                    let mealPub = document.createElement("DIV");
                                    mealPub.append(imgPub);
                                    mealPub.id = "returnedRecipeModalPublic"
                                    document.getElementById('picPublic').append(mealPub);

                                    //add instructions
                                    stepByStep = recipesResponse.results[i].analyzedInstructions[0].steps;
                                    for (let j = 0; j < stepByStep.length; j++) {
                                        let node = document.createElement("LI");
                                        let stepByStepNumber = stepByStep[j].number;
                                        let stepByStepInstruction = stepByStep[j].step;
                                        let textnode = document.createTextNode(stepByStepNumber + ': ' + stepByStepInstruction);
                                        console.log(textnode.nodeValue)
                                        node.appendChild(textnode);
                                        document.getElementById("instructions").appendChild(node);

                                        let nodePub = document.createElement("LI");
                                        let stepByStepNumberPub = stepByStep[j].number;
                                        let stepByStepInstructionPub = stepByStep[j].step;
                                        let textnodePub = document.createTextNode(stepByStepNumberPub + ': ' + stepByStepInstructionPub);
                                        nodePub.appendChild(textnodePub);
                                        document.getElementById("instructionsPublic").appendChild(nodePub);
                                    }
                                    let listOfIngredients = "";
                                    for (let k = 0; k < recipesResponse.results[i].missedIngredients.length; k++) {
                                        listOfIngredients += recipesResponse.results[i].missedIngredients[k].originalString + ", ";


                                    }
                                    document.getElementById("ingredientsNeeded").innerHTML = 'Ingredients needed: ' + listOfIngredients;
                                    document.getElementById("ingredientsNeededPublic").innerHTML = 'Ingredients needed: ' + listOfIngredients;

                                    let listOfDiets = "";
                                    for (let l = 0; l < recipesResponse.results[i].diets.length; l++) {
                                        listOfDiets += recipesResponse.results[i].diets[l] + ", ";


                                    }
                                    document.getElementById("dietsSupported").innerHTML = 'Diets supported: ' + listOfDiets;
                                    document.getElementById("dietsSupportedPublic").innerHTML = 'Diets supported: ' + listOfDiets;

                                }

                            }
                            if (sessionStorage.getItem('jwt') === null) {
                                // modal = document.getElementById("myModalPublic");
                                return "public";
                            }
                            else {

                                return "private";
                            }

                        };
                        let modal;
                        let modalTypeResult = await modalType();
                        console.log(modalTypeResult);
                        if (modalTypeResult === "privateExists") {
                            // Get the modal
                            modal = document.getElementById("myModalPrivateExists");
                        }
                        else if (modalTypeResult === "public") {
                            modal = document.getElementById("myModalPublic");
                        }
                        else {
                            modal = document.getElementById("myModal");
                        }
                        modal.style.display = "block";
                        //   }

                        // When the user clicks on <span> (x), close the modal
                        span.onclick = async function () {
                            if (modalTypeResult === "privateExists") {
                                clonePrivateExists();

                            }
                            else {
                                await publicOrPrivateModal()
                                $("#returnedRecipeModal").remove();
                                $("#returnedRecipeModalPublic").remove();
                            }
                            clearModal();
                            modal.style.display = "none";
                        }

                        // When the user clicks anywhere outside of the modal, close it
                        window.onclick = async function (event) {

                            if (event.target == modal) {
                                if (modalTypeResult === "privateExists") {
                                    clonePrivateExists();

                                }
                                else {
                                    await publicOrPrivateModal()
                                    $("#returnedRecipeModal").remove();
                                    $("#returnedRecipeModalPublic").remove();
                                }
                                clearModal();
                                modal.style.display = "none";
                            }
                        }
                        $(document).on("click", "#saveRecipe", function () {

                            axios.post('http://localhost:3000/user/data/' + sessionStorage.getItem('name') + '/data/savedRecipes',
                                {


                                    "data": [recipeId],
                                    "type": "merge"
                                },
                                {
                                    headers: { Authorization: "Bearer " + sessionStorage.getItem('jwt') }

                                }).then((response) => {
                                    console.log(response);
                                }).catch((error) => {
                                    console.log(error);
                                });


                        });
                        $(document).on("click", "#postReview", async function (e2) {


                            e2.stopImmediatePropagation();
                            e2.preventDefault();
                            let starsChecked = '';
                            if (document.getElementById("star5").checked) {
                                starsChecked = ` <div> <span class="fa fa-star starChecked"></span>
                    <span class="fa fa-star starChecked"></span>
                    <span class="fa fa-star starChecked"></span>
                    <span class="fa fa-star starChecked"></span>
                    <span class="fa fa-star starChecked"></span></div>`
                            }
                            else if (document.getElementById("star4").checked) {
                                starsChecked = ` <div> <span class="fa fa-star starChecked"></span>
                    <span class="fa fa-star starChecked"></span>
                    <span class="fa fa-star starChecked"></span>
                    <span class="fa fa-star starChecked"></span>

                    <span class="fa fa-star "></span>`
                            }
                            else if (document.getElementById("star3").checked) {
                                starsChecked = ` <div> <span class="fa fa-star starChecked"></span>
                    <span class="fa fa-star starChecked"></span>
                    <span class="fa fa-star starChecked"></span>
                    <span class="fa fa-star "></span>
                    <span class="fa fa-star "></span>`
                            }
                            else if (document.getElementById("star2").checked) {
                                starsChecked = ` <div> <span class="fa fa-star starChecked"></span>
                    <span class="fa fa-star starChecked"></span>
                    <span class="fa fa-star "></span>
                    <span class="fa fa-star "></span>
                    <span class="fa fa-star "></span>`
                            }
                            else if (document.getElementById("star1").checked) {
                                starsChecked = ` <div> <span class="fa fa-star starChecked"></span>
                    <span class="fa fa-star "></span>
                    <span class="fa fa-star "></span>
                    <span class="fa fa-star "></span>
                    <span class="fa fa-star "></span>`
                            }


                            let reviewContent = document.getElementById("reviewText").value.toString();
                            let newReview =
                                `  <div id="newReviewBox" class = "box">
                <article class="media">
                        
                    <figure class="media-left">
                        <p class="image is-64x64">
                            <img src="https://bulma.io/images/placeholders/128x128.png">
                        </p>
                    </figure>
                    <div class="media-content">
                            ${starsChecked}
                        <div class="content">
                         <p>
                             <strong>`+ sessionStorage.getItem('name') + `</strong>
                            
                        <br>
                            ${reviewContent}
                        <br>
       
                        </p>
                     </div>
                    
                </article>
                </div>`;

                            // document.getElementById('postedReviews').innerHTML = document.getElementById('postedReviews').innerHTML += newReview;
                            let p = document.createElement("p");
                            p.innerHTML = newReview
                            document.getElementById('postedReviews').append(p);
                            // console.log(e2.currentTarget.parentElement)
                            // e2.currentTarget.append(p);
                            // if (modalTypeResult === "privateExists") {
                            //     $('#myModalPrivateExistsContent').find('#postedReviews').append(p);
                            // }
                            // else if (modalTypeResult === "private") {
                            //     $('#myModalPrivateExistsContent').find('#postedReviews').append(p);
                            // }

                            await cloneModal();

                            //document.getElementById('postedReviews').remove(p);
                            p = '';
                            p.innerHTML = '';
                            document.getElementById("reviewText").value = '';
                            newReview = '';
                            reviewContent = '';

                        });
                        function cloneModal() {
                            //  let clonedModalHTML = $("<div />").append($("#myModal").clone().html());
                            var $clonedModal = $("#myModalContent").clone().html();


                            // console.log($clonedModal)
                            axios.post('http://localhost:3000/private/Recipes/' + recipeId,
                                {

                                    "name": clickedRecipeName,
                                    "data": {
                                        "modal": $clonedModal,

                                    },
                                },
                                {
                                    headers: { Authorization: "Bearer " + sessionStorage.getItem('jwt') }
                                }).then((response) => {

                                    console.log(response);
                                }).catch((error) => {
                                    console.log(error);
                                })

                        }
                        function clonePublicModal() {

                            var $clonedModalPublic = $("#myModalPublic").clone().html();

                            axios.post('http://localhost:3000/public/Recipes/' + recipeId,
                                {

                                    "name": clickedRecipeName,
                                    "data": {
                                        "modal": $clonedModalPublic,

                                    },
                                },
                            ).then((response) => {

                                console.log(response);
                            }).catch((error) => {
                                console.log(error);
                            })
                        }
                        function clonePrivateExists() {
                            var $clonedModalPE = $("#myModalPrivateExists").clone().html();


                            axios.post('http://localhost:3000/private/Recipes/' + recipeId,
                                {

                                    "name": clickedRecipeName,
                                    "data": {
                                        "modal": $clonedModalPE,

                                    },
                                },
                                {
                                    headers: { Authorization: "Bearer " + sessionStorage.getItem('jwt') }
                                }).then((response) => {

                                    console.log(response);
                                }).catch((error) => {
                                    console.log(error);
                                })

                        }

                        function clearModal() {
                            //document.getElementById('postedReviews').innerHTML = document.getElementById('postedReviews').innerHTML = '';
                            $("#postedReviews").empty();
                            $("#myModalPrivateExists").empty();
                            $("#pic").empty();
                            $("#picPublic").empty();
                            $("instructions").empty();
                            $("instructionsPublic").empty();
                            document.getElementById("star5").checked = false;
                            document.getElementById("star4").checked = false;
                            document.getElementById("star3").checked = false;
                            document.getElementById("star2").checked = false;
                            document.getElementById("star1").checked = false;
                            document.getElementById("saveRecipe").checked = false;

                            let myNode = document.getElementById("postedReviews");

                            while (myNode != null && myNode.firstChild != null) {
                                myNode.removeChild(myNode.firstChild);
                            }
                            if (myNode != null) { myNode.innerHTML = ''; }

                            myNode = document.getElementById("returnedRecipeModal");
                            while (myNode != null && myNode.firstChild != null) {
                                myNode.removeChild(myNode.firstChild);
                            }
                            if (myNode != null) { myNode.innerHTML = ''; }
                            myNode = document.getElementById("returnedRecipeModalPublic");
                            while (myNode != null && myNode.firstChild != null) {
                                myNode.removeChild(myNode.firstChild);
                            }
                            if (myNode != null) { myNode.innerHTML = ''; }
                            myNode = document.getElementById("pic");
                            while (myNode != null && myNode.firstChild != null) {
                                myNode.removeChild(myNode.firstChild);
                            }
                            if (myNode != null) { myNode.innerHTML = ''; }
                            myNode = document.getElementById("picPublic");
                            while (myNode != null && myNode.firstChild != null) {
                                myNode.removeChild(myNode.firstChild);
                            }
                            if (myNode != null) { myNode.innerHTML = ''; }
                            myNode = document.getElementById("instructions");
                            while (myNode != null && myNode.firstChild != null) {
                                myNode.removeChild(myNode.firstChild);
                            }
                            if (myNode != null) { myNode.innerHTML = ''; }
                            myNode = document.getElementById("instructionsPublic");
                            while (myNode != null && myNode.firstChild != null) {
                                myNode.removeChild(myNode.firstChild);
                            }
                            if (myNode != null) { myNode.innerHTML = ''; }



                        }
                        function publicOrPrivateModal() {
                            if (sessionStorage.getItem('jwt') === null) {
                                return clonePublicModal();
                            }
                            return cloneModal();
                        }
                        async function privateModalExistsCheck(id) {
                            let bool;
                            await axios.get('http://localhost:3000/private/Recipes/' + id + '/modal',

                                {
                                    headers: { Authorization: "Bearer " + sessionStorage.getItem('jwt') }


                                }).then((response) => {
                                    // console.log(response);
                                    // let p = document.createElement("p");
                                    // p.innerHTML = response.data.result
                                    // document.getElementById('boxFeed').append(p);
                                    alert("worked");
                                    bool = true;


                                }).catch((error) => { console.log(error); alert("didnt work"); bool = false; });
                            return bool;
                        }
                        function appendExistingPrivateModal(id) {
                            axios.get('http://localhost:3000/private/Recipes/' + id + '/modal',

                                {
                                    headers: { Authorization: "Bearer " + sessionStorage.getItem('jwt') }


                                }).then((response) => {
                                    console.log(response);
                                    let d = document.createElement("DIV");
                                    d.classList = "modal-content";
                                    d.id = "myModalPrivateExistsContent";
                                    d.innerHTML = response.data.result;
                                    document.getElementById('myModalPrivateExists').append(d);
                                    alert("append worked");



                                }).catch((error) => { alert("append didnt work"); console.log(error); });
                        }
                    });

                });
                window.onload = function () {
                    document.querySelector("a#logout").addEventListener('click', function (event) {
                        event.preventDefault();
                        sessionStorage.setItem('jwt', null);
                        sessionStorage.setItem('name', null);
                        location.href = '/index.html';
                    });
                }

            </script>
            <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
            <script src="../node_modules/axios/dist/axios.js"></script>
            <script src="script.js" type="module"></script>
            <script>
                var coll = document.getElementsByClassName("collapsible");
                var i;

                for (i = 0; i < coll.length; i++) {
                    coll[i].addEventListener("click", function () {
                        this.classList.toggle("active");
                        var content = this.nextElementSibling;
                        if (content.style.maxHeight) {
                            content.style.maxHeight = null;
                        } else {
                            content.style.maxHeight = content.scrollHeight + "px";
                        }
                    });
                }
            </script>
</body>

</html>